\include{preamble.tex}
\title{Wasserstein stability for the $p$-Dowker nerve}

\begin{document}
	\maketitle
	\section{Setting}	
	We fix a real number $p\geq 1$ and endow the interval $[0,\infty]$ with the binary operation $\otimes\colon [0,\infty]^2\to [0,\infty]$ defined by $t\otimes s := (t^p + s^p)^{\frac{1}{p}}$.

	\begin{defn}
 		Given a Dowker dissimilarity $\Lambda\colon L\times W\to[0,\infty]$, define the \textit{$p$-Dowker nerve} $D^p\Lambda$ of $\Lambda$ by letting
			$$
				D^p\Lambda_t := \left\{\sigma\subseteq L\mid \exists w\in W\text{ such that }\bigotimes_{l\in\sigma}\Lambda(l,w)\leq t\right\}\text{ for }t\in[0,\infty).
			$$
		We sometimes allow ourselves to suppress the $p$ and just write $D\Lambda$.
	\end{defn}

	Let $W=\R^d$ be equipped with the Euclidean distance $d(x,y)=\Vert x-y\Vert_2$, and let $L$ and $L'$ be finite subsets of $W$ with $|L|=|L'|$\footnote{It would be nice if we could drop this assumption.}. Define the Dowker dissimilarity $\Gamma\colon W\times W\to [0,\infty]$ by letting $\Gamma(w,w')=d(w,w')$, and let $\Lambda=\Gamma\mid_{L\times W}$ and $\Lambda'=\Gamma\mid_{L'\times W}$. Setting $p=\infty$ we have that $D\Lambda$ and $D\Lambda'$ are the ambient Čech filtrations of the point clouds $L$ and $L'$, respectively. In this case, we have classical stability, i.e., the bottleneck distance between the persistence diagrams are upper-bounded by the Hausdorff distance between the two point clouds. In this note, we apply the Cellular Wasserstein Stability Theorem of \autocite{skraba2022wasserstein} to establish an analogous stability result for the case $1\leq p<\infty$.
	
	\section{Definitions}
	
	Let $D$ and $D'$ be two persistence diagrams. A \textit{matching} $M$ between $D$ and $D'$ is a set of pairs $(x,y)$ with $x\in X\cup\Delta$, $y\in Y\cup\Delta$ and every $x\in X$ and $y\in Y$ is used exactly once. Here $\Delta$ denotes the diagonal.
	
	\begin{defn}[$p$-Wasserstein distance]
		Given $p\geq 1$, the \textit{$p$-Wasserstein distance} between $D$ and $D'$ is defined as
		$$
			\textbf{W}_p(D,D') := \inf_{M} \left(\sum_{(x,y)\in M}\Vert x-y\Vert^p_p\right)^{\frac{1}{p}}
		$$
		where $M$ ranges over all matchings between the two diagrams. If $D=(D_k)_k$ and $D'=(D'_k)_k$, which is the case when we consider different homological dimensions, we define the \textit{total $p$-Wasserstein distance} by
		$$
			\textbf{W}_p(D,D') := \left(\sum_k W_p(D_k,D_k')^p\right)^{\frac{1}{p}}.
		$$
	\end{defn}

	\begin{defn}[$L^p$ norm]
		Let $K$ be a finite CW-complex. The \textit{$L^p$ norm} of a function $f\colon K\to\R$ is given by $\Vert f\Vert_p = \left(\sum_{\sigma\in K}\vert f(\sigma)\vert^p\right)^{\frac{1}{p}}$. Given two monotone functions $f,g\colon K\to\R$, the \textit{$L^p$ distance} between $f$ and $g$ is the distance induced by the $L^p$ norm. That is,
		$$
		\Vert f-g\Vert_p = \left(\sum_{\sigma\in K}\vert f(\sigma) - g(\sigma)\vert^p\right)^{\frac{1}{p}}.
		$$
	\end{defn}

	 The following definition of the point set Wasserstein distance appears in \autocite{skraba2022wasserstein}.

	\begin{defn}[$p$-Wasserstein point set distance]
		Given $p\geq 1$ and two point sets $L$ and $L'$ with $|L|=|L'|$, we define the \textit{$p$-Wasserstein distance} between $L$ and $L'$ by
		$$
		\textbf{WP}_p(L,L') := \inf_{\phi}\left(\sum_{l\in L}\Vert l - \phi(l)\Vert_2^p\right)^{\frac{1}{p}}
		$$
		where $\phi\colon L\to L'$ ranges over all bijections.
	\end{defn}

	\section{Stability}
	\begin{thm}[Cellular Wasserstein Stability Theorem \autocite{skraba2022wasserstein}]\label{thm:cellular_wasserstein_stability}
		Let $K$ be a finite CW complex and let $f,g\colon K\to\R$ be monotone functions. Then
		$$
			\textbf{W}_p(\Dgm(f), \Dgm(g))\leq\Vert f-g\Vert_p.
		$$
		For a fixed homological dimension $k$, we have
		$$
			\textbf{W}_p(\Dgm_k(f), \Dgm_k(g))^p \leq \sum_{k\leq \dim(\sigma)\leq k+1}\vert f(\sigma)-g(\sigma)\vert^p.
		$$
	\end{thm}

	For the rest of this section, let $L$ and $L'$ be finite subsets of $W=\R^d$ with $n=|L|=|L'|$. Define the Dowker dissimilarity $\Gamma\colon W\times W\to [0,\infty]$ by letting $\Gamma(w,w')=d(w,w')$, and let $\Lambda=\Gamma\mid_{L\times W}$ and $\Lambda'=\Gamma\mid_{L'\times W}$. Let $\Dgm(\Lambda)$ denote the persistence diagram corresponding to the sublevel set homology of the filtration function $D\Lambda\to\R$ defined by 
	\begin{equation}\label{eq:filtration_function}
		\sigma\mapsto \inf\{t\in[0,\infty]\mid\sigma\in D\Lambda_t\} = \inf_{w\in W}\bigotimes_{l\in\sigma}\Lambda(l,w)=\inf_{w\in W}\left(\sum_{l\in\sigma}\Vert l-w\Vert_2^p\right)^{\frac{1}{p}}.
	\end{equation}

	\begin{cor}[Stability of the $p$-Dowker nerve]
		Let $\Lambda$ and $\Lambda'$ be defined as above. Then
		$$
			\textbf{W}_p(\Dgm(\Lambda), \Dgm(\Lambda'))\leq C\cdot\textbf{WP}_p(L,L').
		$$
		where $C=(2^n-1)^{\frac{1}{p}}$.
	\end{cor}

	\begin{proof}
		Let $\phi\colon L\to L'$ be a bijection minimizing the point set $p$-Wasserstein distance $\textbf{WP}_p(L,L')$. Let $f\colon D\Lambda\to\R$ be the filtration function defined in \cref{eq:filtration_function}. Similarly, let $f'\colon D\Lambda'\to\R$ be the filtration function for $D\Lambda'$ and define $g:=f'\circ\varphi\colon D\Lambda\to\R$. For $\sigma\in D\Lambda$, we have
		
		\begin{align*}
			\vert f(\sigma) - g(\sigma)\vert &= \left\vert \inf_{w\in W}\bigotimes_{l\in\sigma}\Lambda(l,w) - \inf_{w\in W}\bigotimes_{l\in\sigma}\Lambda(\varphi(l),w)\right\vert\\
			&\overset{(1)}\leq\sup_{w\in W}\left\vert\bigotimes_{l\in\sigma}\Lambda(l,w)-\bigotimes_{l\in\sigma}\Lambda(\varphi(l),w)\right\vert\\
			&=\sup_{w\in W}\left\vert \left(\sum_{l\in\sigma}\Vert l-w\Vert_2^p\right)^{\frac{1}{p}} - \left(\sum_{l\in\sigma}\Vert \varphi(l)-w\Vert_2^p\right)^{\frac{1}{p}}\right\vert \\
			&\overset{(2)}\leq\sup_{w\in W}\left\vert \left(\sum_{l\in\sigma}\vert\Vert l-w\Vert_2-\Vert \varphi(l)-w\Vert_2\vert^p \right)^{\frac{1}{p}} \right\vert\\
			&\overset{(3)}\leq\sup_{w\in W}\left(\sum_{l\in\sigma}\Vert l-\varphi(l)\Vert_2^p \right)^{\frac{1}{p}} =\left(\sum_{l\in\sigma}\Vert l-\varphi(l)\Vert_2^p \right)^{\frac{1}{p}}\leq\textbf{WP}_p(L,L') \\
		\end{align*}
	
		In $(1)$ we used the inequality $\vert\inf f - \inf g\vert\leq \sup\vert f-g\vert$. In $(2)$ and $(3)$ we used the reverse triangle inequality $\vert\Vert x\Vert-\Vert y\Vert\vert\leq\Vert x-y\Vert$ for the $L^p$ norm and the $L^2$ norm, respectively. Applying \cref{thm:cellular_wasserstein_stability} we then get
		
		\begin{align*}
			\textbf{W}_p(\Dgm(\Lambda), \Dgm(\Lambda'))&\leq \Vert f-g\Vert_p = \left(\sum_{\sigma\in D\Lambda}\vert f(\sigma)-g(\sigma)\vert^p\right)^{\frac{1}{p}}\\
			&\leq\left(\sum_{\sigma\in D\Lambda}\textbf{WP}_p(L,L')^p\right)^{\frac{1}{p}}\\
			&= \left(\sum_{k=1}^n\binom{n}{k}\right)^{\frac{1}{p}}\textbf{WP}_p(L,L')\\
			&=(2^n-1)^{\frac{1}{p}}\textbf{WP}_p(L,L')
		\end{align*}
		
		Similarly, if we fix the homological dimension $k\geq0$, we get that
		\begin{align*}
			\textbf{W}_p(\Dgm_k(\Lambda), \Dgm_k(\Lambda'))&\leq\left(\binom{n}{k}+\binom{n}{k+1}\right)^{\frac{1}{p}}\textbf{WP}_p(L,L') = \binom{n+1}{k+1}^{\frac{1}{p}}\textbf{WP}_p(L,L').
		\end{align*}
	
	\end{proof}
	
	\section{Duplicating points}
	The Čech nerve $N^\infty\Lambda$ does not change, up to homotopy, if we duplicate a point that is already in the point set. This is however not the case for the $p$-nerve in general as the following example shows.
	
	\begin{ex}[Duplicating a point can change the Wasserstein distance between persistence diagrams]
		Let $p=2$ and consider the point set $L=\{x,y\}\subset\R^2$ with $x\neq y$. Clearly, the Dowker $p$-nerve $D\Lambda$ has trivial $1$-homology. Now, suppose we duplicate the point $x$. That is, let $L'=\{x,x',y\}$ with $x=x'$. The $2$-simplex $\sigma=\{x,x',y\}$ is born at time $d=\sqrt{\frac{2}{3}}\Vert x-y\Vert_2$. However, the faces of $\sigma$ are born at time $0$ or $b=\sqrt{\frac{1}{2}}\Vert x-y\Vert_2$, meaning that we have a non-trivial persistent $1$-cycle in $D\Lambda'$. Note that in the $p=\infty$ case, the $2$-simplex will have the same birth time as its faces, killing any new cycles. The $2$-Wasserstein distance between the persistence diagrams (in homological dimension $1$) corresponding to $\Lambda$ and $\Lambda'$ can then be computed to be $\frac{d-b}{\sqrt{2}}$ which is proportional to the distance between $x$ and $y$.
		
		\begin{figure}[h!]
			\centering
			\includestandalone[width=.8\textwidth]{figs/duplicated_point_dowker_p_nerve}
			\caption{Duplicating a point can lead to the birth of a new non-trivial cycle. In the $p=\infty$ case, the triangle would already be filled in at $t=b$.}
		\end{figure}
	\end{ex}
	
	\section{Network distance}
	A correspondence between two sets $X$ and $X'$ is a subset $C\subseteq X\times X'$ such that the projection maps to $X$ and $X'$ are onto. A non-negatively weighted network $\omega_X$ consists of a set $X$ together with a function $\omega_X\colon X\times X\to[0,\infty)$. We will typically be interested in weighted networks on the form $\omega_L=\Lambda=d\colon L\times L\to[0,\infty)$.
	
	\begin{defn}
		Let $\omega\colon X\times X\to[0,\infty)$ and $\omega'\colon X'\times X'\to[0,\infty)$ be weighted networks and let $C\subseteq X\times X'$. We define the \textit{$p$-distortion of $C$} as 
		$$
		\dis^p(C) = \left(\sum_{\substack{(x,x'),(y,y')\in C}}\vert\omega(x,y)-\omega'(x',y')\vert^p\right)^{\frac{1}{p}}.
		$$
	\end{defn}
	
	\begin{defn}
		Let $\mathcal{R}=\mathcal{R}(X,X')$ denote the set of all correspondences $C\subseteq X\times X'$ and let $\omega$ and $\omega'$ be weighted networks as in the above definition. Define the \textit{$p$-network distance} between $X$ and $X'$ as
		$$
		d_N^p(X,X')=\frac{1}{2}\inf_{C\in\mathcal{R}}\dis^p(C).
		$$
	\end{defn}
	Note that if $(M,d_M)$ and $(N,d_N)$ are metric spaces, and $\omega(x,y)=d_M(x,y)$, $\omega'(x',y')=d_N(x',y')$, then the $p$-network distance agrees with the Gromov-Hausdorff distance when $p=\infty$.
	
	\begin{ex}[Duplicating points does not change the network distance]
		Let $X=\{x_1,x_2,\ldots, x_n\}$ be finite point set in $\R^d$, and let $X'$ be $X$ with one of the points $x'=x_i$ duplicated. We consider the weighted networks with the weight function $\omega$ being the $L_2$ distance on $\R^d$. Let $C\subseteq X\times X'$ be the correspondence consisting of all pairs on the form $(x_j, x_j)$ for $1\leq j\leq n$, and the pair $(x_i, x')$. Then, clearly $\dis^p(C)=0$ and hence $d_N^p(X,X')=0$.
	\end{ex}
	
	\section{Computing witnesses in $\R^d$}
	In this section, suppose $L\subseteq W=\R^d$ and $\Lambda\colon L\times W\to [0,\infty]$ is given by $\Lambda(l,w)=\Vert l-w\Vert_q$ for some fixed $q$. Fix some $p$ and consider the $p$-nerve $D\Lambda=D^p\Lambda$ of $\Lambda$. Given a simplex $\sigma\in L$, we want to know at what time $t$ the simplex $\sigma$ appears in the $p$-nerve. In other words, we want to compute the infimum
	$$
	\inf_{w\in W}\left(\sum_{l\in\sigma}\Lambda(l,w)^p\right)^{\frac{1}{p}}.
	$$
	In this section, we give a description of $w^*\in W$ minimizing the above sum for different values of $p$ and $q$. Let $g_\sigma\colon W\to[0,\infty]$ be given by $g_\sigma(w)=\sum_{l\in\sigma}\Lambda(l,w)^p$. The partial derivatives of $g_\sigma$ are 
	$$
	\frac{\partial g_\sigma}{\partial w_i}(w)=p\sum_{l\in\sigma}\Vert l-w\Vert_q^{p-q}(w_i-l_i)|l_i-w_i|^{q-2}
	$$
	so any minimal point $w\in W$ must satisfy
	\begin{equation}
	w_i = \frac{\sum_{l\in\sigma}l_i\Vert l-w\Vert_q^{p-q}|l_i-w_i|^{q-2}}{\sum_{l\in\sigma}\Vert l-w\Vert_q^{p-q}|l_i-w_i|^{q-2}}
	\label{eq:extreme_point_condition}
	\end{equation}
	for all $i=1,2,\ldots, d$. For simplicity, we set $q=2$ to get rid of the factors $|l_i-w_i|^{q-2}$. In the case $p=2$, $w$ is the centroid of the points in $\sigma$. In the case $p=1$, $w$ is the geometric median of $\sigma$.\footnote{The geometric median has many names, including the Fermat-Weber point, $L_1$-median, spatial median, Euclidean minisum point and Torricelli point.} A witness for $\sigma$ is the root of the function $G_\sigma\colon W\to W$ defined by
	$$
	G_\sigma(w)=\frac{\boldsymbol{\sigma}D(w)}{\mathbf{1}^\top D(w)}-w.
	$$
	where $\boldsymbol{\sigma}$ is the $d\times(k+1)$ matrix with $\boldsymbol{\sigma}_{ij}=l^j_i$ representing the $k$-simplex $\sigma=\{l^0,\ldots,l^k\}\subseteq L$, and $D(w)$ is the column vector with $D(w)_i=\Vert l^i - w\Vert^{p-2}_2$.
	
	\begin{prop}
		Any point $w^*\in W$ satisfying \cref{eq:extreme_point_condition} is a global minimum point of $g_\sigma$.
	\end{prop}
	\begin{proof}
		The function $w\mapsto\Vert l-w\Vert_q$ is convex for every $l\in\sigma$. The function $x\mapsto x^p$ is convex and non-decreasing, hence the composition of the two functions is also convex. Since $g_\sigma$ is a finite sum of convex functions, $g_\sigma$ is also convex.
	\end{proof}

	

	\section{Comments}
	\begin{enumerate}
		\item We use $q=p$ in the Wasserstein distance. Can we generalize for other choices of $q$? (See definition in \autocite{skraba2022wasserstein} for example.)
		\item In the definition of the point set $p$-Wasserstein distance and the dissimilarities we use $q=2$. Other choices of $q$ are probably interleaved with ours.
		\item What about the case when $|L|\neq|L'|$?
		\item Could be interesting to look at the part about stability in \autocite{Brun_2019}[p.~14-16].
	\end{enumerate}

	\printbibliography

\end{document}